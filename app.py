import json
import os
import io
import threading
import requests
import traceback
import pandas as pd
import numpy as np
import datetime
from datetime import timezone
from flask import Flask, flash, jsonify, request
from flask_cors import CORS
import logging
from random import randint
#from werkzeug import secure_filename
from cvrp import *
from gql import Client, gql
from gql.transport.requests import RequestsHTTPTransport

app = Flask(__name__)
CORS(app)

# constant seed for reproducibility
np.random.seed(3425)

# Check running of instances for reverse proxy
check = randint(0, 9999)

# Graphql Client setup
transport = RequestsHTTPTransport(
    url=f'{os.environ.get("NODE_URL")}/graphql',
    verify=True,
    retries=3,
)
client = Client(transport=transport, serialize_variables=True, fetch_schema_from_transport=True)
 
@app.route("/", methods = ["GET", "POST"])
def home():
    return jsonify({
        "identifier": check, 
    })



@app.route("/route", methods = ["GET", "POST"])
def generate_route():
    if (request.method == "POST"):
        clustered = request.args.get("clustered") == "1"
        gql_result = None
        if clustered:
            print("Executing /route?clustered=1")
            req_data = request.get_json()
            node_data = pd.read_json(req_data["data"])
            cluster_label = node_data["cluster_label"][0]
            depot = pd.read_json(req_data["depot"])
            node_data = pd.concat([depot, node_data]).reset_index(drop=True)
            
            # find route using ortools
            print(f"-------Solution Route Cluster #{cluster_label} ({req_data['id']}) start time-------", get_timestamp())
            solution = find_route(node_data, req_data["capacities"], req_data["num_of_vehicles"], req_data["timeout"])
            print(f"-------Solution Route Cluster #{cluster_label} ({req_data['id']}) end time-------", get_timestamp())
            
            if solution:
                route_distances = solution[1]
                truck_routes = []
                for sol in solution[0]:
                    route = [node_data['node'][i] for i in sol]
                    truck_routes.append(route)
                print(truck_routes)
                # update the solution
                for i in range(len(truck_routes)):
                    query = gql(
                    """
                        mutation updateProblemInfoSolution(
                                $id: ID!,
                                $tour: [Int],
                                $tourDistance: Int
                            ) {
                            updateProblemInfoSolution(id: $id, input: {
                                tour: $tour,
                                tourDistance: $tourDistance
                            }) {
                                nModified
                                n
                                ok
                            }
                        }
                    """
                    )
                    variables = {
                        "id": req_data['id'],
                        "tour": truck_routes[i],
                        "tourDistance": route_distances[i]
                    }
                    gql_result = client.execute(query, variables)
                    # print("gql -> ", gql_result)
                return jsonify({
                    "identifier": check,
                    "clustered": clustered,
                    "gql_result": gql_result,
                    "solution": True,
                    "timeout": req_data["timeout"]
                })
            else:
                return jsonify({
                    "identifier": check,
                    "clustered": clustered,
                    "solution": False,
                    "timeout": req_data["timeout"]
                })
        else:
            print("Executing /route")
            data = request.get_json()
            id = data.get('id')
            # uint8arr = [80,75,3,4,20,0,8,8,8,0,56,145,106,86,0,0,0,0,0,0,0,0,0,0,0,0,11,0,0,0,95,114,101,108,115,47,46,114,101,108,115,173,146,207,74,3,49,16,135,239,125,138,144,123,119,182,21,68,100,179,189,136,208,155,72,125,128,152,204,254,97,55,153,48,25,117,125,123,131,8,90,169,165,7,143,73,126,243,205,55,67,154,221,18,102,245,138,156,71,138,70,111,170,90,43,140,142,252,24,123,163,159,14,247,235,27,189,107,87,205,35,206,86,74,36,15,99,202,170,212,196,108,244,32,146,110,1,178,27,48,216,92,81,194,88,94,58,226,96,165,28,185,135,100,221,100,123,132,109,93,95,3,255,100,232,246,136,169,246,222,104,222,251,141,86,135,247,132,151,176,169,235,70,135,119,228,94,2,70,57,209,226,87,162,144,45,247,40,70,47,51,188,17,79,207,68,83,85,160,26,78,187,108,47,119,249,123,78,8,40,214,91,177,224,136,113,157,184,84,179,140,152,191,117,60,185,135,114,157,63,19,231,132,174,254,115,57,184,8,70,143,254,188,146,77,233,203,104,213,192,209,39,104,63,0,80,75,7,8,102,170,130,183,224,0,0,0,59,2,0,0,80,75,3,4,20,0,8,8,8,0,56,145,106,86,0,0,0,0,0,0,0,0,0,0,0,0,15,0,0,0,120,108,47,119,111,114,107,98,111,111,107,46,120,109,108,141,83,201,110,219,48,16,189,247,43,4,222,109,45,94,106,27,150,3,87,142,144,0,221,16,167,201,153,146,70,22,107,138,20,200,241,150,162,255,222,17,101,165,41,218,67,15,54,57,11,223,188,153,121,90,222,156,107,233,29,193,88,161,85,204,194,97,192,60,80,185,46,132,218,197,236,219,99,58,152,49,207,34,87,5,151,90,65,204,46,96,217,205,234,221,242,164,205,62,211,122,239,209,123,101,99,86,33,54,11,223,183,121,5,53,183,67,221,128,162,72,169,77,205,145,76,179,243,109,99,128,23,182,2,192,90,250,81,16,76,253,154,11,197,58,132,133,249,31,12,93,150,34,135,141,206,15,53,40,236,64,12,72,142,196,222,86,162,177,108,181,44,133,132,167,174,33,143,55,205,103,94,19,237,132,203,156,249,171,87,218,95,141,151,241,124,127,104,82,202,142,89,201,165,5,106,180,210,167,47,217,119,200,145,58,226,82,50,175,224,8,225,60,24,247,41,127,64,104,164,76,42,67,206,214,241,36,224,100,127,199,91,211,33,222,105,35,94,180,66,46,183,185,209,82,198,12,205,225,90,141,136,162,200,255,21,217,182,131,122,228,153,237,157,231,103,161,10,125,138,25,173,232,242,230,126,114,215,103,81,96,69,11,156,142,102,227,222,119,7,98,87,97,204,102,225,60,98,30,242,236,161,29,84,204,38,1,61,43,133,177,232,138,56,20,78,157,28,129,234,181,22,53,228,191,233,200,237,172,63,61,229,6,234,94,134,45,85,58,239,11,170,236,116,130,20,58,10,43,50,73,140,205,66,80,192,220,23,145,67,236,97,168,221,156,230,47,16,12,229,39,250,160,136,66,216,114,50,80,126,210,5,65,172,9,237,26,127,93,206,213,222,128,68,78,36,135,65,16,182,176,112,198,143,22,221,121,85,146,212,116,255,75,77,82,100,6,58,253,56,41,49,239,96,68,204,126,188,159,70,211,100,54,141,6,209,58,28,13,194,240,118,50,248,48,26,79,6,233,109,154,210,224,146,77,50,79,127,146,172,28,234,130,126,73,71,223,162,161,111,228,1,202,237,133,86,123,238,36,182,118,148,124,202,234,254,29,51,191,87,196,234,23,80,75,7,8,139,120,51,237,247,1,0,0,110,3,0,0,80,75,3,4,20,0,8,8,8,0,56,145,106,86,0,0,0,0,0,0,0,0,0,0,0,0,13,0,0,0,120,108,47,115,116,121,108,101,115,46,120,109,108,237,88,93,111,155,48,20,125,223,175,176,252,190,66,210,52,109,39,66,213,117,202,180,151,169,90,83,169,210,180,7,23,12,88,245,7,178,157,54,244,215,239,26,3,129,166,221,164,116,210,18,41,79,246,61,220,115,124,184,190,8,67,116,177,18,28,61,82,109,152,146,51,60,58,10,49,162,50,81,41,147,249,12,223,46,230,31,207,48,50,150,200,148,112,37,233,12,87,212,224,139,248,67,100,108,197,233,77,65,169,69,160,32,205,12,23,214,150,159,130,192,36,5,21,196,28,169,146,74,184,146,41,45,136,133,80,231,129,41,53,37,169,113,36,193,131,113,24,78,3,65,152,196,113,36,151,98,46,172,65,137,90,74,11,54,58,8,249,225,91,10,224,116,130,145,151,187,82,41,88,249,74,37,213,132,227,32,142,130,70,32,142,50,37,215,58,19,236,129,56,50,207,232,145,112,16,9,93,186,36,130,250,248,82,51,175,144,17,193,120,229,193,113,45,233,137,91,208,195,157,161,215,131,43,10,227,188,43,202,24,123,32,142,74,98,45,213,114,14,1,106,230,139,170,132,202,74,216,106,47,83,231,253,37,59,215,164,26,141,79,122,132,122,128,117,239,149,78,161,181,250,219,234,33,148,50,146,43,73,248,109,57,195,25,225,134,226,14,250,162,158,100,11,198,17,167,153,5,97,205,242,194,141,86,149,129,19,177,86,9,152,180,28,183,180,87,238,38,176,124,66,57,191,113,125,122,151,173,239,62,4,209,85,182,217,87,178,14,160,253,157,247,102,234,149,154,128,148,37,175,230,202,137,88,189,164,13,240,185,78,25,64,151,156,229,82,208,23,137,215,90,89,154,216,250,49,171,225,56,34,109,34,42,148,102,207,32,237,54,48,111,218,218,61,149,150,37,14,242,247,139,145,165,43,251,67,89,226,85,192,211,147,38,229,2,192,174,136,76,166,245,194,112,205,20,154,201,135,133,154,179,238,50,148,169,236,108,32,174,146,7,154,182,38,11,150,2,181,151,25,172,178,23,149,10,215,117,26,109,91,167,198,231,203,66,245,225,126,165,218,54,216,31,51,227,131,153,55,204,108,253,108,29,204,28,204,28,204,28,204,28,204,108,99,102,114,188,75,111,202,201,104,167,220,76,118,202,205,120,151,220,156,255,103,51,65,255,248,238,15,243,253,115,252,182,199,248,85,182,233,188,239,231,157,214,247,237,76,255,158,178,253,187,13,223,131,170,5,77,3,246,62,43,187,102,156,226,30,138,220,7,250,12,127,119,127,42,120,175,112,247,75,198,45,147,62,10,54,9,87,74,8,210,230,143,78,6,132,227,55,9,232,103,248,171,35,77,7,164,233,171,164,165,214,84,38,85,199,57,29,112,38,127,226,12,214,58,27,240,78,95,227,93,83,157,192,30,116,148,243,1,197,255,48,88,23,19,130,245,79,165,248,55,80,75,7,8,6,55,195,113,141,2,0,0,153,18,0,0,80,75,3,4,20,0,8,8,8,0,56,145,106,86,0,0,0,0,0,0,0,0,0,0,0,0,24,0,0,0,120,108,47,119,111,114,107,115,104,101,101,116,115,47,115,104,101,101,116,49,46,120,109,108,189,157,91,115,219,198,150,133,223,231,87,176,244,144,202,84,197,22,55,239,76,100,157,50,1,58,201,137,111,229,203,100,106,94,166,104,17,178,88,166,8,134,132,236,36,191,126,64,234,98,105,175,15,102,103,30,182,31,18,137,252,212,13,46,52,154,171,27,141,94,39,255,250,243,114,217,250,92,108,182,139,114,245,228,200,30,183,143,90,197,234,172,156,47,86,31,159,28,189,127,247,236,209,232,168,181,173,102,171,249,108,89,174,138,39,71,127,21,219,163,127,157,254,199,201,151,114,243,105,123,81,20,85,171,46,96,181,125,114,116,81,85,235,31,143,143,183,103,23,197,229,108,251,184,92,23,171,250,157,243,114,115,57,171,234,95,55,31,143,183,235,77,49,155,239,255,232,114,121,220,105,183,7,199,151,179,197,234,232,186,132,31,55,41,101,148,231,231,139,179,34,47,207,174,46,139,85,117,93,200,166,88,206,170,250,240,183,23,139,245,246,182,180,63,231,73,229,205,55,179,47,245,71,189,61,158,123,135,152,95,191,115,87,158,245,164,188,203,197,217,166,220,150,231,213,227,179,242,242,230,208,244,83,142,143,199,15,62,231,229,89,202,129,93,206,54,159,174,214,143,234,130,215,245,135,251,176,88,46,170,191,246,199,120,116,122,178,47,252,245,166,117,190,88,86,197,230,69,57,175,207,203,249,108,185,45,234,247,214,179,143,197,219,162,122,191,222,191,95,189,43,95,215,47,220,190,125,124,122,114,124,243,199,167,39,243,69,45,225,238,180,183,54,197,249,147,163,167,246,227,203,78,219,118,204,30,249,175,69,241,101,123,239,231,214,246,162,252,242,172,62,194,171,229,108,123,91,224,254,197,159,55,139,249,243,197,170,168,95,173,54,87,55,47,190,41,191,100,229,242,151,90,138,186,109,221,127,227,127,138,90,179,219,23,54,139,143,23,245,49,62,47,206,171,187,34,171,217,135,183,197,178,56,171,138,249,253,191,123,117,85,45,235,74,222,254,117,249,161,92,222,21,48,47,206,103,87,203,106,119,8,117,117,229,230,246,245,207,245,17,63,57,90,237,4,93,214,69,150,235,93,21,89,177,92,238,62,232,81,235,108,199,254,90,151,63,232,29,181,254,46,203,203,183,103,179,101,45,147,181,219,247,126,127,185,255,115,255,234,78,208,231,179,191,202,171,189,44,55,239,238,46,135,15,101,249,105,247,210,174,220,246,238,52,237,63,197,78,224,245,108,119,233,220,28,197,81,107,86,191,250,185,184,62,154,231,214,185,255,194,245,223,182,182,127,236,207,201,238,205,187,115,182,43,250,254,207,183,39,231,217,190,213,212,167,251,70,139,90,135,223,23,243,234,162,62,50,123,220,239,246,173,63,232,244,239,148,170,207,203,47,197,78,245,250,237,206,227,250,226,254,187,62,31,183,175,220,156,129,242,90,234,231,197,231,98,89,243,251,35,186,255,90,93,195,245,39,60,126,112,0,55,199,147,207,170,217,233,201,166,252,210,170,207,198,78,235,171,109,85,94,94,67,119,85,124,173,255,98,49,159,23,171,187,55,174,233,111,28,208,254,104,234,243,183,156,173,183,187,22,114,219,240,207,118,213,237,206,237,118,79,212,127,188,173,95,253,124,218,62,57,254,92,31,233,217,13,49,81,194,30,18,153,18,157,135,68,174,68,247,33,49,85,162,247,144,120,166,68,255,33,241,179,18,131,135,196,47,74,12,31,18,191,42,49,122,72,252,251,154,176,123,196,248,33,241,27,40,230,68,125,14,136,83,245,5,32,78,214,151,122,40,246,85,215,227,186,69,221,53,171,78,112,179,234,220,59,248,21,53,154,137,18,93,119,62,179,195,72,174,136,83,122,170,132,83,241,89,231,190,138,213,166,102,206,235,14,102,118,247,145,254,247,207,229,249,234,113,246,234,101,246,244,221,247,223,253,113,85,86,63,189,126,51,121,180,186,254,241,135,159,59,63,92,255,244,232,211,205,43,207,59,255,121,114,124,190,171,106,207,213,95,66,143,62,153,107,104,63,251,227,122,88,103,246,234,253,203,119,223,215,95,49,79,251,237,250,223,109,121,117,81,174,69,127,187,152,23,79,255,251,251,188,243,99,254,160,144,158,59,21,191,126,187,140,183,239,95,104,25,93,27,185,107,235,223,223,46,229,245,155,87,249,251,236,221,247,191,117,238,201,211,237,249,207,243,27,156,46,207,60,135,198,229,212,125,113,176,253,189,188,127,214,111,136,238,176,225,234,233,6,95,61,221,67,109,118,162,132,63,171,25,32,174,163,202,21,241,29,213,244,91,135,242,64,163,94,176,70,61,237,28,156,70,64,248,30,70,17,223,146,114,69,28,49,85,162,65,162,126,176,68,125,109,1,78,34,37,250,94,34,40,196,119,194,138,152,255,122,87,164,65,163,65,176,70,3,85,192,105,4,132,215,72,145,142,187,142,114,69,204,93,141,83,40,133,53,26,6,107,52,148,3,115,125,255,68,9,243,26,41,210,245,26,41,210,113,21,77,1,97,141,70,193,26,141,14,117,19,19,37,58,94,35,69,68,35,64,156,68,80,15,75,52,14,150,104,44,7,230,172,245,68,9,127,29,101,138,244,189,68,128,56,137,160,30,150,200,218,209,195,177,182,28,154,235,38,38,128,248,111,237,12,152,158,107,39,249,225,170,166,128,52,9,21,62,110,181,131,42,76,128,145,174,27,152,129,111,80,84,151,239,152,128,105,146,42,122,44,102,96,134,253,104,12,24,223,245,100,192,168,84,80,151,72,245,173,33,217,67,169,162,141,183,129,35,246,214,27,24,233,165,128,25,120,215,148,80,215,148,234,106,144,42,218,127,27,120,103,239,192,129,241,189,117,6,140,140,242,169,46,233,171,146,109,184,69,251,112,3,131,236,157,56,48,122,1,130,139,22,169,128,145,185,182,100,55,110,209,118,220,192,39,123,67,158,192,100,196,72,95,117,216,182,79,137,105,144,42,218,149,27,152,110,239,203,129,209,86,165,140,52,42,69,70,94,168,100,103,110,209,214,220,212,17,251,81,254,132,24,17,10,156,181,180,41,40,71,122,170,100,135,110,209,22,221,212,25,155,55,233,192,200,213,167,136,12,100,128,145,111,191,100,159,222,137,246,233,29,48,225,222,168,3,35,70,1,152,158,87,138,234,242,82,81,93,13,82,69,59,245,14,56,99,239,212,129,145,46,29,24,177,159,84,142,159,174,163,227,105,144,42,252,174,9,56,99,185,111,162,140,159,144,203,128,17,251,9,140,239,168,232,112,26,148,138,54,234,29,48,198,222,168,3,163,74,29,54,243,57,48,126,252,52,165,114,252,13,159,251,200,214,187,192,135,114,70,155,249,14,152,103,111,230,129,81,57,193,168,139,156,192,120,55,65,199,211,32,85,180,153,239,128,121,246,102,30,24,153,120,32,198,43,5,85,201,53,154,236,229,59,209,94,190,3,222,217,123,121,96,124,79,149,1,163,247,129,129,241,74,37,91,249,78,180,149,239,28,158,249,158,0,163,74,65,57,114,249,29,156,205,159,82,49,13,74,69,123,249,14,120,103,239,229,129,209,142,42,97,170,29,24,53,19,201,94,190,19,237,229,59,224,158,189,151,7,70,87,97,40,163,22,21,198,13,210,170,146,221,124,55,218,205,119,193,61,123,55,15,140,222,114,87,166,235,239,39,3,35,82,209,241,52,72,21,237,230,187,234,158,253,133,51,1,102,208,243,82,41,211,243,171,198,128,241,95,127,128,52,41,21,109,230,187,48,165,238,205,60,48,254,218,202,128,145,113,15,48,126,224,48,37,166,65,170,240,245,46,234,158,187,178,226,5,24,185,254,148,233,75,163,2,167,238,123,117,98,26,164,138,118,234,93,152,46,247,78,157,24,223,171,3,51,144,229,65,135,71,5,83,98,26,164,138,118,234,93,152,82,247,78,29,152,126,215,75,5,140,180,42,152,226,151,11,48,217,170,119,163,173,122,247,176,197,158,0,35,6,20,24,63,240,201,129,241,119,67,166,192,52,73,21,237,213,187,48,165,238,189,58,48,3,105,85,135,253,124,14,140,31,41,3,210,164,84,180,87,239,130,199,246,94,29,152,142,23,74,17,253,254,83,198,175,249,248,102,77,15,133,138,118,234,93,112,225,222,169,3,35,147,201,9,76,14,140,52,169,100,163,222,139,54,234,61,48,216,222,168,3,35,203,62,15,34,57,32,98,211,129,105,18,42,218,166,247,192,94,123,155,14,140,191,176,50,96,252,189,135,28,24,239,204,166,192,52,73,21,237,211,123,224,193,189,79,39,70,164,2,127,45,173,234,240,164,59,21,211,160,84,180,77,239,193,132,186,183,233,9,76,6,140,172,186,6,39,239,133,74,95,154,30,190,54,29,166,202,101,117,58,24,103,63,72,6,70,175,62,88,99,227,149,74,246,232,189,104,143,222,131,229,229,222,163,3,227,135,33,25,48,126,189,35,32,178,146,63,217,161,247,162,29,122,79,29,177,159,212,156,0,227,7,33,25,49,61,175,20,48,222,36,0,211,36,85,180,67,239,169,37,238,121,135,14,204,192,43,5,70,127,228,149,58,188,6,103,10,76,147,82,209,14,189,7,51,229,222,161,3,35,253,57,20,35,74,193,100,186,23,42,217,161,247,162,29,122,15,230,192,189,67,7,102,228,133,130,165,51,3,47,20,184,111,233,167,146,29,122,63,218,161,247,213,19,251,199,206,38,192,248,165,163,25,48,50,233,2,140,31,138,79,129,105,146,42,218,163,247,97,121,186,247,232,192,248,126,138,16,127,245,1,227,103,237,167,192,52,41,21,109,209,251,234,137,251,222,162,3,227,251,178,44,129,201,129,209,167,217,146,61,122,63,218,163,247,15,79,129,79,128,241,215,104,70,229,72,171,74,120,126,20,152,38,169,162,93,122,31,156,179,119,233,192,248,222,56,3,70,30,182,1,198,15,252,168,170,6,165,194,31,36,133,25,112,121,148,20,28,184,40,5,140,121,165,14,47,150,159,2,211,36,85,180,79,239,31,158,1,159,16,35,82,129,191,246,247,103,128,17,159,78,229,52,72,21,237,211,251,176,240,220,251,116,96,100,38,29,24,63,62,204,137,241,74,37,251,244,126,180,79,239,195,244,182,247,233,196,136,82,96,194,197,84,193,116,187,87,42,217,168,247,163,141,122,31,28,182,55,234,192,248,187,205,25,48,170,148,50,222,168,3,210,244,220,123,180,81,31,128,193,246,70,29,24,111,176,51,96,252,218,181,28,24,233,168,168,156,6,169,162,141,250,224,240,68,249,4,24,191,2,35,35,198,207,189,16,35,82,37,59,245,65,180,83,31,192,98,21,239,212,129,241,235,234,50,96,252,189,251,156,24,175,84,178,81,31,68,27,245,1,60,34,234,141,58,48,190,23,202,128,209,70,5,229,136,84,201,70,125,16,109,212,7,176,86,197,27,117,96,100,58,29,24,25,211,0,163,27,117,36,59,245,65,180,83,31,168,51,246,75,239,38,192,200,152,134,202,241,246,19,24,25,254,81,93,13,82,133,239,252,114,120,61,203,4,24,121,46,9,152,161,159,84,0,70,26,85,178,81,31,68,27,245,1,152,112,111,212,137,145,174,74,25,85,234,240,18,246,41,49,13,82,69,59,245,1,184,103,239,212,129,145,233,23,96,134,126,76,3,140,191,225,60,37,166,65,170,104,171,62,80,111,236,231,45,39,196,72,87,117,240,121,212,28,16,85,42,217,170,15,163,173,250,80,173,177,239,140,39,192,248,193,116,6,140,95,61,147,19,35,155,48,37,91,245,97,180,85,31,170,53,30,122,171,14,140,204,84,1,35,51,197,192,136,82,201,78,125,24,237,212,135,106,141,135,222,169,3,163,74,193,220,188,31,255,17,227,149,74,118,234,195,104,167,62,132,229,42,222,169,3,35,83,122,192,200,141,26,96,188,225,152,2,211,36,85,180,83,31,194,110,137,222,169,3,35,55,106,128,241,247,213,115,96,164,83,39,166,65,170,104,167,62,132,229,40,222,169,3,227,87,199,100,192,200,30,150,192,120,251,9,72,147,82,209,70,125,8,6,219,27,117,96,252,154,143,12,24,63,10,206,129,241,179,47,128,52,41,21,190,81,35,24,108,217,170,17,86,199,120,247,9,140,95,72,148,19,35,82,37,27,245,97,180,81,31,130,193,246,70,29,24,149,10,24,63,81,12,140,76,191,0,211,36,85,180,81,31,194,60,183,55,234,192,200,221,7,96,228,62,41,48,114,247,15,152,166,77,64,163,157,250,72,157,241,208,59,117,96,252,20,105,6,140,172,126,1,70,182,2,77,54,234,163,104,163,62,82,103,60,242,70,29,24,49,85,192,200,218,51,96,228,57,54,98,26,164,138,118,234,35,181,198,35,239,212,129,145,225,31,48,242,116,50,48,126,76,3,72,147,82,209,78,125,164,206,120,228,157,58,48,178,55,7,49,126,78,29,24,217,173,152,152,6,169,162,157,250,72,157,241,200,59,117,96,100,246,19,24,25,40,83,57,34,85,178,83,31,69,59,245,145,90,227,145,119,234,192,248,239,173,12,24,189,254,18,158,35,5,166,73,170,104,171,62,2,251,236,173,58,48,178,74,29,24,89,40,4,140,191,253,14,72,147,82,209,86,125,4,143,118,122,171,14,140,191,110,50,96,252,70,88,57,48,254,9,167,41,149,211,32,85,248,214,234,106,141,71,178,185,58,216,112,175,20,184,112,113,10,240,200,170,159,83,0,166,73,169,104,167,62,130,37,232,222,169,3,227,23,24,100,192,168,84,80,142,116,234,201,78,125,28,237,212,199,106,141,71,222,169,3,227,63,98,6,140,56,117,96,252,244,11,85,213,160,84,180,83,31,195,46,44,222,169,3,163,74,193,180,187,191,81,3,140,76,127,82,93,13,82,69,59,245,49,60,222,233,157,58,48,178,143,9,48,254,182,87,78,229,120,165,146,157,250,56,218,169,143,213,25,143,189,83,7,70,236,39,49,254,150,22,49,94,169,100,163,62,142,54,234,99,88,57,238,141,58,48,222,4,100,9,76,78,140,87,42,217,167,143,163,125,250,24,102,185,189,79,7,198,127,179,101,192,200,138,42,98,68,170,100,159,62,142,246,233,99,88,143,226,125,58,48,218,167,3,35,29,213,97,102,74,76,131,84,209,70,125,172,198,120,236,141,58,48,146,237,67,140,180,170,132,197,47,196,52,72,21,109,212,199,234,140,199,222,168,3,163,93,213,225,77,30,115,96,100,160,76,229,52,72,21,158,133,164,206,120,44,105,72,135,87,173,100,196,248,129,50,48,178,127,56,149,195,82,237,211,123,67,181,218,215,232,197,210,84,36,133,188,19,200,8,18,185,176,36,201,133,160,146,154,4,11,207,70,106,83,56,146,164,35,1,165,65,54,4,249,59,241,4,105,148,84,122,64,82,59,60,33,169,13,75,210,219,146,145,68,148,55,15,41,80,142,144,255,78,36,168,81,177,240,160,164,54,61,251,41,81,73,64,201,2,34,130,100,8,77,144,10,150,158,150,212,14,143,75,106,211,214,232,18,152,4,148,220,114,78,129,114,130,228,145,111,130,26,21,11,79,77,106,211,250,114,201,77,2,202,183,158,140,32,191,44,62,199,250,36,187,12,160,70,197,194,195,147,218,148,122,36,241,73,64,65,191,127,216,253,231,4,105,191,159,158,160,212,14,143,80,106,195,12,123,91,66,148,128,146,221,191,8,210,204,27,128,100,159,94,132,154,20,139,182,248,251,26,69,49,73,83,2,74,158,134,35,72,110,29,98,125,126,70,16,171,107,82,44,60,82,169,13,246,187,45,161,74,68,233,55,37,44,135,215,88,79,40,73,175,202,116,191,31,159,129,138,9,167,98,248,129,146,137,84,130,252,99,41,57,65,154,153,247,79,178,80,227,195,80,193,240,67,28,42,172,167,145,175,74,128,252,6,211,57,215,39,138,165,59,254,248,76,84,12,69,21,199,15,148,223,120,38,35,72,7,149,84,146,8,150,110,248,227,147,81,41,174,84,179,81,129,146,237,31,17,82,193,14,207,236,79,9,106,84,44,220,241,83,106,169,70,164,82,254,169,54,49,128,180,27,3,51,175,138,165,59,254,248,156,84,10,74,213,164,84,160,52,213,57,37,42,53,41,43,245,31,132,165,198,167,165,82,204,169,230,165,18,165,23,37,172,160,215,38,6,102,94,251,253,116,199,31,31,154,74,169,169,26,155,74,185,169,254,222,7,22,37,67,36,130,100,24,254,15,194,83,227,211,83,41,210,84,243,83,129,2,111,1,142,95,59,254,20,199,255,15,50,84,227,67,84,41,69,85,99,84,41,221,84,28,63,65,234,198,96,67,27,17,44,221,240,135,135,169,26,37,156,74,156,42,82,34,24,64,106,95,41,117,85,186,177,244,72,85,11,207,84,53,10,58,149,84,85,164,252,83,25,41,80,78,144,88,139,244,96,85,11,79,86,53,200,50,53,201,86,37,74,158,56,64,72,102,248,41,59,85,50,179,211,3,86,45,60,97,213,40,246,84,50,86,137,146,125,31,8,82,111,1,144,10,150,238,247,195,51,84,141,130,77,37,69,149,40,29,33,1,228,219,97,78,144,10,150,110,247,195,147,84,13,178,75,77,178,84,145,18,47,70,105,170,42,88,202,4,127,122,160,170,133,39,170,26,100,152,154,100,170,18,37,183,41,129,209,155,110,84,157,152,215,244,92,85,11,15,86,53,136,50,53,137,86,37,74,123,253,132,237,224,9,130,94,63,221,237,135,231,171,26,133,158,74,194,42,81,234,93,1,146,253,14,8,146,251,186,233,33,171,22,158,178,106,20,125,42,57,171,68,249,187,67,25,65,242,44,35,214,39,195,163,244,172,85,11,15,91,53,74,64,149,184,85,162,252,211,194,25,65,178,80,26,235,243,207,20,19,212,168,88,184,219,135,148,83,147,212,85,162,188,47,205,8,210,54,70,1,174,34,88,186,219,15,143,94,53,200,58,53,9,95,37,10,4,3,143,174,77,12,234,147,241,81,122,0,171,133,39,176,26,68,158,154,100,176,18,165,235,121,0,146,189,3,177,62,25,130,167,231,176,90,120,16,171,65,242,169,73,20,43,81,222,54,100,4,249,221,75,114,172,207,47,227,36,168,81,177,112,191,79,33,169,146,200,74,148,108,229,130,69,201,106,11,10,92,149,137,177,244,84,86,11,143,101,53,202,74,149,96,86,162,100,71,9,130,116,98,140,114,87,181,231,79,55,252,225,233,172,6,121,168,38,249,172,68,233,172,69,66,138,107,142,245,137,129,77,15,105,181,240,148,86,131,96,84,147,156,86,162,100,35,126,132,180,231,63,188,193,60,49,141,130,133,59,126,200,71,53,201,107,37,74,118,153,39,72,30,202,34,72,189,69,186,225,15,15,109,53,202,82,149,216,86,162,124,194,93,70,144,60,68,138,245,201,16,41,61,188,213,194,211,91,141,98,87,37,191,149,40,191,133,127,134,69,169,98,84,159,40,150,238,248,195,67,92,13,98,83,77,98,92,137,210,38,118,112,11,156,156,24,233,244,211,131,92,45,60,201,213,32,60,213,36,203,21,41,153,181,32,72,6,72,20,214,170,138,165,219,253,240,72,87,163,44,86,9,117,37,74,23,190,82,81,98,94,9,18,243,154,158,236,106,225,209,174,6,105,170,38,225,174,68,233,37,153,178,124,159,170,147,17,101,122,194,171,133,71,188,26,102,179,138,219,7,74,167,18,169,40,237,245,1,18,43,150,30,244,106,225,73,175,70,249,171,146,245,74,148,183,31,25,22,165,23,101,202,106,158,244,192,87,11,79,124,53,202,97,149,204,87,162,212,188,18,36,110,31,32,181,98,233,110,63,60,249,213,32,107,213,36,251,149,40,121,86,151,32,93,197,153,80,210,20,161,6,197,194,19,96,141,226,93,37,3,150,40,85,140,82,96,165,27,163,250,196,91,164,231,192,90,120,16,172,65,244,170,73,20,44,81,190,33,102,4,249,187,81,57,214,39,183,41,211,243,96,45,60,16,214,40,165,85,34,97,137,146,93,49,9,146,109,249,176,62,233,248,211,99,97,45,60,23,214,40,172,85,146,97,137,146,237,25,82,160,28,235,211,54,150,238,248,195,227,97,13,2,89,77,2,98,137,210,165,194,148,237,42,131,202,4,104,138,80,147,98,225,142,159,178,91,37,40,150,40,29,35,1,228,173,112,142,245,137,229,79,15,139,181,240,180,88,163,8,87,201,139,37,74,167,198,0,210,169,49,130,180,31,75,183,252,225,161,177,6,49,173,38,177,177,68,201,46,191,4,249,53,180,57,66,218,198,210,45,127,120,120,172,81,234,171,196,199,18,229,239,15,101,8,201,64,156,234,147,9,235,244,12,89,11,15,145,53,74,127,149,24,89,162,188,105,203,82,160,156,235,19,197,210,61,127,120,152,172,81,194,171,196,201,18,165,87,37,64,218,243,83,125,242,93,153,30,41,107,225,153,178,6,33,174,38,169,178,68,201,38,108,4,121,237,115,44,73,174,202,244,100,89,11,143,150,53,202,141,149,112,89,162,116,179,6,138,169,21,63,70,225,177,218,198,210,61,127,120,196,172,81,238,171,132,204,18,5,87,37,44,234,209,171,242,240,242,160,41,65,141,138,133,123,126,138,127,149,172,89,162,188,213,202,8,242,35,212,156,235,19,197,210,61,127,120,224,172,81,10,172,68,206,18,165,11,46,0,82,7,75,245,201,50,168,244,216,89,11,207,157,53,10,149,149,228,89,162,64,49,88,197,47,115,23,0,249,181,144,83,130,26,21,11,247,252,16,248,106,146,64,75,20,40,150,176,13,39,65,50,117,145,30,66,107,225,41,180,6,177,175,38,57,180,68,233,64,28,32,63,191,145,99,125,106,46,210,45,127,120,24,173,65,252,171,73,28,45,81,58,72,2,200,223,246,204,9,146,173,94,17,106,80,44,60,148,214,32,5,214,36,150,150,40,185,245,150,144,93,155,99,117,114,63,60,61,153,214,194,163,105,13,194,96,77,194,105,137,210,94,140,226,105,101,150,159,234,147,81,101,122,66,173,133,71,212,26,132,194,154,132,212,18,229,191,28,50,44,74,46,74,10,161,21,111,145,158,84,107,225,81,181,70,249,177,18,86,75,148,228,138,98,81,178,252,149,178,104,229,171,50,61,176,214,194,19,107,141,162,102,37,179,150,40,29,135,83,81,170,88,202,50,254,244,220,90,11,15,174,53,76,156,21,199,79,148,152,11,74,157,213,126,12,198,14,34,88,186,225,15,207,175,53,10,158,149,4,91,162,228,209,26,138,185,213,22,150,176,225,62,66,77,130,133,251,125,202,150,149,32,91,166,68,49,24,20,104,191,79,203,136,68,177,116,195,31,158,102,107,20,49,43,121,182,68,249,53,178,25,66,234,198,160,62,237,247,211,13,127,120,168,173,81,210,172,196,218,18,165,115,99,0,233,93,17,172,79,20,75,55,252,225,217,182,6,105,178,38,233,182,68,233,220,24,21,37,109,140,210,107,101,80,153,30,113,107,225,25,183,6,161,178,38,41,183,68,233,214,89,148,79,171,138,29,222,202,103,138,37,53,41,22,238,248,33,92,214,36,236,150,40,125,54,156,114,106,85,177,20,199,159,158,120,107,225,145,183,6,25,179,38,161,183,68,233,46,147,0,249,111,221,156,32,93,159,152,30,124,107,225,201,183,70,113,180,146,125,75,148,174,132,2,200,175,16,202,177,36,249,174,76,207,191,181,240,0,92,163,84,90,137,192,37,74,199,72,4,201,189,74,130,228,187,50,61,6,215,194,115,112,141,66,110,37,9,151,40,93,65,0,144,191,161,153,99,125,250,93,153,238,249,195,243,112,141,194,110,37,17,151,40,245,99,4,169,98,41,75,249,211,83,113,45,60,22,215,48,208,86,60,63,80,126,73,94,134,69,169,98,180,53,144,40,150,238,249,195,227,113,13,115,109,197,243,3,229,23,102,100,88,148,220,171,36,72,198,149,233,33,185,22,158,146,107,144,75,107,146,147,75,148,127,166,36,35,72,215,92,80,14,174,40,150,30,150,107,225,105,185,70,17,182,146,151,75,148,62,196,5,144,111,136,57,214,39,211,99,233,153,185,22,30,154,107,16,83,107,18,155,75,20,40,6,11,254,85,49,40,73,70,73,233,217,185,22,30,158,107,152,122,43,158,159,40,113,176,4,201,10,130,132,36,222,41,65,141,138,133,123,126,136,173,53,137,209,69,74,220,5,65,50,219,67,144,172,185,72,207,210,181,240,48,93,163,164,92,137,211,69,74,60,63,22,37,138,29,78,230,157,18,212,168,88,184,231,135,16,91,147,84,93,162,116,209,5,64,122,127,151,234,147,81,82,122,178,174,133,71,235,26,100,217,154,132,235,18,165,163,36,128,52,126,139,178,115,245,170,76,247,252,225,9,187,70,177,183,146,177,75,148,198,214,0,164,155,50,39,68,241,78,17,106,82,44,220,243,83,250,173,68,237,18,5,109,44,197,243,99,125,162,88,178,231,239,132,199,237,118,48,73,215,123,126,162,228,105,84,130,36,26,9,33,63,18,71,168,73,177,104,207,223,193,36,93,239,249,137,18,63,70,144,108,51,76,144,183,99,120,76,78,176,227,237,69,81,84,249,172,154,157,158,172,55,139,85,245,106,93,45,202,213,182,117,81,204,230,139,213,199,237,157,22,31,55,139,249,243,90,12,120,229,109,81,151,95,109,174,118,250,150,155,197,223,229,170,154,45,179,98,85,21,155,175,74,181,62,23,155,106,113,166,111,28,215,53,207,62,22,47,102,155,143,139,186,226,101,113,94,151,214,126,60,28,237,110,232,111,174,207,199,237,175,85,185,174,207,223,227,118,191,51,188,251,87,159,203,15,101,85,159,60,122,103,247,49,138,205,215,2,206,203,178,186,247,251,77,221,245,7,184,90,183,214,179,117,177,121,187,248,187,120,114,180,187,54,235,67,173,127,218,167,60,159,47,170,119,229,239,139,121,117,81,191,112,243,235,109,83,169,127,223,21,241,106,179,175,103,94,126,89,189,187,40,86,175,234,79,91,183,159,205,162,254,176,179,157,162,79,142,214,229,166,218,204,22,85,125,184,203,217,217,167,167,171,249,239,23,139,170,184,211,103,190,153,157,127,109,122,103,197,114,153,149,151,151,245,223,215,138,175,202,85,177,171,119,179,173,94,215,149,189,188,186,252,176,171,173,174,251,106,91,60,243,47,251,83,145,175,23,79,142,186,187,15,114,123,14,190,190,114,86,174,23,187,115,106,59,45,174,213,122,182,215,168,53,95,156,159,215,231,105,85,237,203,255,122,152,183,47,191,154,207,167,159,191,94,65,167,39,229,124,254,203,190,128,211,239,102,151,235,159,178,253,127,191,251,227,170,172,126,122,183,184,44,182,173,151,197,151,214,155,242,114,182,250,225,77,241,241,106,57,219,92,191,185,231,172,179,255,223,211,147,227,175,197,236,74,188,62,152,255,95,137,59,77,90,251,159,95,239,139,189,41,235,228,248,254,231,172,127,253,82,110,62,237,175,131,211,255,3,80,75,7,8,129,32,5,4,250,23,0,0,219,247,0,0,80,75,3,4,20,0,8,8,8,0,56,145,106,86,0,0,0,0,0,0,0,0,0,0,0,0,26,0,0,0,120,108,47,95,114,101,108,115,47,119,111,114,107,98,111,111,107,46,120,109,108,46,114,101,108,115,173,145,77,107,195,48,12,134,239,253,21,70,247,197,73,7,99,140,56,189,140,65,175,253,248,1,198,81,226,208,196,54,146,214,181,255,126,46,27,91,10,101,236,208,147,208,215,243,190,72,245,234,52,141,234,136,196,67,12,6,170,162,4,133,193,197,118,8,189,129,253,238,237,225,25,86,205,162,222,224,104,37,143,176,31,18,171,188,19,216,128,23,73,47,90,179,243,56,89,46,98,194,144,59,93,164,201,74,78,169,215,201,186,131,237,81,47,203,242,73,211,156,1,205,21,83,173,91,3,180,110,43,80,187,115,194,255,176,99,215,13,14,95,163,123,159,48,200,13,9,205,114,30,145,51,209,82,143,98,224,43,47,50,7,244,109,249,229,61,229,63,34,29,216,35,202,175,131,159,82,54,119,9,213,95,102,30,239,122,11,111,9,219,173,80,126,236,252,36,243,242,183,153,69,173,175,222,221,124,2,80,75,7,8,79,240,249,122,210,0,0,0,37,2,0,0,80,75,3,4,20,0,8,8,8,0,56,145,106,86,0,0,0,0,0,0,0,0,0,0,0,0,20,0,0,0,120,108,47,115,104,97,114,101,100,83,116,114,105,110,103,115,46,120,109,108,149,147,193,78,195,48,12,134,239,60,69,149,59,203,134,4,66,83,219,29,144,120,2,56,87,86,234,181,17,141,29,98,167,218,222,158,12,33,184,161,244,152,248,251,243,251,151,157,246,116,9,75,179,98,18,207,212,153,195,110,111,26,36,199,163,167,169,51,239,111,175,247,207,166,17,5,26,97,97,194,206,92,81,204,169,191,107,69,180,41,82,146,206,204,170,241,104,173,184,25,3,200,142,35,82,169,156,57,5,208,114,76,147,149,152,16,70,153,17,53,44,246,97,191,127,178,1,60,153,198,113,38,45,182,143,166,201,228,63,51,190,252,94,244,173,248,190,253,54,57,74,4,87,188,203,43,130,105,69,211,19,143,216,90,237,91,123,131,254,1,23,80,175,185,22,102,154,234,233,177,164,165,177,10,141,201,115,242,122,173,130,9,66,101,3,62,32,221,230,86,69,7,184,12,27,90,86,86,88,182,11,52,101,247,33,131,131,82,174,13,188,9,38,30,248,252,99,83,57,166,200,58,84,47,12,71,245,161,4,89,97,201,117,138,244,71,217,242,43,250,47,80,75,7,8,95,89,228,142,251,0,0,0,83,3,0,0,80,75,3,4,20,0,8,8,8,0,56,145,106,86,0,0,0,0,0,0,0,0,0,0,0,0,17,0,0,0,100,111,99,80,114,111,112,115,47,99,111,114,101,46,120,109,108,141,82,203,78,195,48,16,188,243,21,145,239,137,243,64,168,88,73,42,1,170,132,68,17,18,69,32,110,198,222,166,134,216,177,108,247,245,247,56,73,147,22,232,129,219,206,206,120,246,229,124,186,147,117,176,1,99,69,163,10,148,68,49,10,64,177,134,11,85,21,232,101,49,11,39,40,176,142,42,78,235,70,65,129,246,96,209,180,188,200,153,38,172,49,240,100,26,13,198,9,176,129,55,82,150,48,93,160,149,115,154,96,108,217,10,36,181,145,87,40,79,46,27,35,169,243,208,84,88,83,246,69,43,192,105,28,95,97,9,142,114,234,40,110,13,67,61,58,162,131,37,103,163,165,94,155,186,51,224,12,67,13,18,148,179,56,137,18,124,212,58,48,210,158,125,208,49,39,74,41,220,94,195,89,233,64,142,234,157,21,163,112,187,221,70,219,172,147,250,254,19,252,54,127,120,238,70,13,133,106,87,197,0,149,249,161,17,194,12,80,7,60,240,6,164,47,55,48,175,217,237,221,98,134,202,52,78,179,48,206,194,36,94,164,25,201,38,36,77,222,115,252,235,125,107,216,199,141,41,91,246,8,124,204,193,50,35,180,243,55,236,201,31,9,143,107,170,170,181,95,120,9,42,188,127,236,36,99,170,61,101,77,173,155,251,163,47,5,240,155,189,247,56,147,27,58,146,135,220,255,71,186,38,151,147,147,145,6,131,174,178,129,141,104,255,94,153,116,69,71,216,118,109,215,31,159,192,92,63,210,8,124,236,132,171,161,79,15,225,159,255,88,126,3,80,75,7,8,163,110,165,100,98,1,0,0,219,2,0,0,80,75,3,4,20,0,8,8,8,0,56,145,106,86,0,0,0,0,0,0,0,0,0,0,0,0,16,0,0,0,100,111,99,80,114,111,112,115,47,97,112,112,46,120,109,108,157,144,77,111,194,48,12,134,239,251,21,85,196,181,77,91,182,130,80,26,180,105,218,9,105,59,116,104,183,42,75,92,200,148,47,37,41,42,255,126,1,52,224,60,159,236,215,214,99,251,37,235,73,171,236,0,62,72,107,90,84,21,37,202,192,112,43,164,217,181,232,179,123,203,151,40,11,145,25,193,148,53,208,162,35,4,180,166,15,228,195,91,7,62,74,8,89,34,152,208,162,125,140,110,133,113,224,123,208,44,20,169,109,82,103,176,94,179,152,74,191,195,118,24,36,135,87,203,71,13,38,226,186,44,27,12,83,4,35,64,228,238,10,68,23,226,234,16,255,11,21,150,159,238,11,219,238,232,18,143,146,14,180,83,44,2,37,248,150,118,54,50,213,73,13,180,74,242,181,32,207,206,41,201,89,76,142,208,141,252,246,240,126,94,129,23,197,188,88,20,245,108,35,205,56,245,95,203,166,111,30,179,187,129,62,189,240,3,60,226,121,57,123,25,165,18,121,77,240,61,236,68,222,94,172,166,213,83,81,166,56,15,252,105,4,223,92,165,191,80,75,7,8,131,131,231,152,249,0,0,0,154,1,0,0,80,75,3,4,20,0,8,8,8,0,56,145,106,86,0,0,0,0,0,0,0,0,0,0,0,0,19,0,0,0,91,67,111,110,116,101,110,116,95,84,121,112,101,115,93,46,120,109,108,189,84,59,79,195,48,16,222,251,43,34,175,40,118,203,128,16,74,218,129,199,8,149,40,51,50,241,37,49,141,31,178,221,210,254,123,206,41,84,85,9,41,136,136,201,178,239,190,151,79,118,54,219,168,38,89,131,243,210,232,156,76,232,152,36,160,11,35,164,174,114,242,180,184,75,47,201,108,58,202,22,91,11,62,193,94,237,115,82,135,96,175,24,243,69,13,138,123,106,44,104,172,148,198,41,30,112,235,42,102,121,177,228,21,176,243,241,248,130,21,70,7,208,33,13,145,131,76,179,27,40,249,170,9,201,237,6,143,119,186,8,39,201,245,174,47,74,229,132,91,219,200,130,7,44,179,88,101,157,56,7,141,239,1,174,181,56,114,151,126,56,163,136,108,123,124,45,173,63,251,94,193,234,234,72,64,170,152,44,158,119,35,94,45,116,67,218,2,98,30,240,186,157,20,144,204,185,11,247,92,97,3,123,142,73,24,29,56,79,151,210,166,97,111,198,45,95,140,89,210,254,107,239,80,51,101,41,11,16,166,88,41,132,80,111,29,112,225,107,128,160,26,218,174,84,113,169,79,232,251,176,109,192,15,173,222,146,254,32,121,11,240,172,93,38,3,155,216,243,159,240,177,27,247,225,28,254,105,244,190,230,14,196,99,112,248,190,7,159,192,33,119,159,15,196,207,157,177,30,127,6,7,191,55,241,153,59,162,83,139,68,224,130,236,31,253,94,17,169,255,156,26,226,91,23,32,190,106,143,50,214,126,148,211,119,80,75,7,8,143,246,229,54,89,1,0,0,87,5,0,0,80,75,1,2,20,0,20,0,8,8,8,0,56,145,106,86,102,170,130,183,224,0,0,0,59,2,0,0,11,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,95,114,101,108,115,47,46,114,101,108,115,80,75,1,2,20,0,20,0,8,8,8,0,56,145,106,86,139,120,51,237,247,1,0,0,110,3,0,0,15,0,0,0,0,0,0,0,0,0,0,0,0,0,25,1,0,0,120,108,47,119,111,114,107,98,111,111,107,46,120,109,108,80,75,1,2,20,0,20,0,8,8,8,0,56,145,106,86,6,55,195,113,141,2,0,0,153,18,0,0,13,0,0,0,0,0,0,0,0,0,0,0,0,0,77,3,0,0,120,108,47,115,116,121,108,101,115,46,120,109,108,80,75,1,2,20,0,20,0,8,8,8,0,56,145,106,86,129,32,5,4,250,23,0,0,219,247,0,0,24,0,0,0,0,0,0,0,0,0,0,0,0,0,21,6,0,0,120,108,47,119,111,114,107,115,104,101,101,116,115,47,115,104,101,101,116,49,46,120,109,108,80,75,1,2,20,0,20,0,8,8,8,0,56,145,106,86,79,240,249,122,210,0,0,0,37,2,0,0,26,0,0,0,0,0,0,0,0,0,0,0,0,0,85,30,0,0,120,108,47,95,114,101,108,115,47,119,111,114,107,98,111,111,107,46,120,109,108,46,114,101,108,115,80,75,1,2,20,0,20,0,8,8,8,0,56,145,106,86,95,89,228,142,251,0,0,0,83,3,0,0,20,0,0,0,0,0,0,0,0,0,0,0,0,0,111,31,0,0,120,108,47,115,104,97,114,101,100,83,116,114,105,110,103,115,46,120,109,108,80,75,1,2,20,0,20,0,8,8,8,0,56,145,106,86,163,110,165,100,98,1,0,0,219,2,0,0,17,0,0,0,0,0,0,0,0,0,0,0,0,0,172,32,0,0,100,111,99,80,114,111,112,115,47,99,111,114,101,46,120,109,108,80,75,1,2,20,0,20,0,8,8,8,0,56,145,106,86,131,131,231,152,249,0,0,0,154,1,0,0,16,0,0,0,0,0,0,0,0,0,0,0,0,0,77,34,0,0,100,111,99,80,114,111,112,115,47,97,112,112,46,120,109,108,80,75,1,2,20,0,20,0,8,8,8,0,56,145,106,86,143,246,229,54,89,1,0,0,87,5,0,0,19,0,0,0,0,0,0,0,0,0,0,0,0,0,132,35,0,0,91,67,111,110,116,101,110,116,95,84,121,112,101,115,93,46,120,109,108,80,75,5,6,0,0,0,0,9,0,9,0,63,2,0,0,30,37,0,0,0,0]
            uint8arr = data.get('file').get('data') # [78,65,77,69,32,...]
            # file = io.StringIO(bytes(uint8arr).decode('utf-8')) # in-memory file(.vrp)
            file = io.BytesIO(bytes(uint8arr)) # in-memory file(excel)
            # contents = file.getvalue()
            
            try:
                # p1 = parse_file(contents)
                p1 = parse_file(file)
            except Exception:
                traceback.print_exc()
                return jsonify({"message": "Unable to parse file."}), 400
            
            file.close()
            nodeData = json.loads(p1.node_data.to_json(orient="records"))

            # update the problemInfo with data
            query = gql(
                """
                    mutation UpdateProblemInfo(
                            $id: ID!,
                            $name: String
                            $dimension: Int
                            $vehicles: Int
                            $optimalValue: Int
                            $capacity: Int
                            $depotNode: Int
                            $nodeData: [NodeInfoInput]
                        ) {
                        updateProblemInfo(id: $id, input: {
                            name: $name,
                            dimension: $dimension,
                            vehicles: $vehicles,
                            optimalValue: $optimalValue,
                            capacity: $capacity,
                            depotNode: $depotNode,
                            nodeData: $nodeData,
                        }) {
                            nModified
                            n
                            ok
                        }
                    }
                """
            )
            variables = {
                "id": id,
                "name": p1.name,
                "dimension": p1.dimension,
                "vehicles": p1.vehicles,
                "optimalValue": p1.optimal_value,
                "capacity": p1.capacity,
                "depotNode": p1.depot_node,
                "nodeData": nodeData
            }
            gql_result = client.execute(query, variables)

            # return response and continue sending requests in another thread
            thread = threading.Thread(target=distribute_task, kwargs={
                'id': id,
                'p1': p1,
            })
            thread.start()

            return jsonify({
                "clustered": clustered,
                "identifier": check,
                "gql_result": gql_result,
            }), 202
    
    if (request.method == "GET"):
        # just to check if endpoint is active
        return jsonify({"identifier": check})
    
def distribute_task(**kwargs):
    # time consuming task distribution
    id = kwargs.get('id', None)
    p1 = kwargs.get('p1', {})
    depot = p1.node_data.loc[p1.node_data['node'] == p1.depot_node]
    node_data = p1.node_data.drop(p1.node_data[p1.node_data['node'] == p1.depot_node].index)
    print(f'-------Problem ({id}) clustering start time-------', get_timestamp())
    [clusters, vehicles] = cluster(node_data, p1.vehicles, p1.capacity)
    print(f'-------Problem ({id}) clustering end time-------', get_timestamp(), clusters)

    payload_queue = [{
        "id": id,
        "capacities": np.random.choice(
            a=[p1.capacity+j*10 for j in range(3)], 
            size=vehicles[i],
        ).tolist(),
        # "capacities": [p1.capacity for x in range(vehicles[i])], 
        "num_of_vehicles": vehicles[i],
        "depot": depot.to_json(orient="records"),
        "data":clusters[i].to_json(orient="records"),
        "timeout": 10,
    } for i in range(len(vehicles))]

    url = f"{os.environ.get('SOLVER_URL')}/route?clustered=1"
    headers = {'content-type': 'application/json'}
    while payload_queue:
        try:
            payload = payload_queue.pop(0)
            # Fire and forget (Hacky)
            res = requests.post(url, json=payload, headers=headers)
            data = res.json()
            if not data["solution"] and data["timeout"] < 30:
                payload.update({
                    "timeout": payload["timeout"] + 40
                })
                payload_queue.append(payload)
        except requests.exceptions.ReadTimeout:
            pass

def get_timestamp():
    dt = datetime.datetime.now(timezone.utc)
    utc_time = dt.replace(tzinfo=timezone.utc)
    return utc_time.timestamp()

# main driver function
if __name__ == "__main__":
    app.run(debug=os.environ.get("FLASK_DEBUG", True))

if __name__ != "__main__":
	# For logging in prod
    gunicorn_error_logger = logging.getLogger("gunicorn.error")
    app.logger.handlers = gunicorn_error_logger.handlers
    app.logger.setLevel(gunicorn_error_logger.level)
